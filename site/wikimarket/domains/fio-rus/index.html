<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Именной домен .РУС для {{user_name}} | UpgradeFor</title>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,200,0,0"
  >
  <link rel="stylesheet" href="/assets/layout.css">
</head>
<body class="is-home">
  <a class="skip" href="#main">К содержанию</a>

  <header></header>
  <aside class="sidebar" aria-hidden="true"></aside>

  <main id="main" class="app-content">
    <section class="wrap hero" aria-labelledby="hero-title">
      <div>
        <h1 id="hero-title">Здравствуйте, <span data-user-name>{{user_name}}</span>!</h1>
        <p class="lead">Ваш персональный домен уже доступен:</p>
        <p style="font-size:clamp(22px,4vw,40px);font-weight:700;margin:0 0 var(--space-3)"><span data-user-domain>{{user_domain}}</span></p>
        <div class="cta" style="display:flex;gap:12px;margin-top:var(--space-3);flex-wrap:wrap">
          <a class="btn" href="#form" data-cta-link="primary">Оформить домен</a>
          <span class="tag" aria-label="Срок предложения">Предложение действительно 24 часа</span>
        </div>
        <p class="lead" id="domain-missing-note" hidden>Домен не определён. Используйте персональную ссылку.</p>
        <div class="card" style="margin-top:var(--space-3)" aria-label="Контейнер таймера">
          <strong>Таймер:</strong>
          <div id="countdown" style="margin-top:8px;color:var(--muted)">24:00:00</div>
        </div>
      </div>
      <div class="hero-art" aria-label="Визуальный блок домена">
        <div style="padding:var(--space-4);text-align:center">
          <div class="tag" style="margin-bottom:var(--space-2)">Домен .РУС</div>
          <div style="font-size:clamp(24px,4vw,42px);font-weight:700"><span data-user-domain>{{user_domain}}</span></div>
          <p class="lead" style="margin-top:var(--space-2)">Запоминающийся адрес для вашего проекта.</p>
        </div>
      </div>
    </section>

    <section class="wrap" id="benefits" aria-labelledby="benefits-title">
      <h2 class="section-title" id="benefits-title">Преимущества домена .РУС</h2>
      <div class="cards-6">
        <article class="card">
          <span class="material-symbols-outlined" aria-hidden="true">public</span>
          <h3>Локальная идентичность</h3>
          <p>Показывает связь с русскоязычной аудиторией.</p>
        </article>
        <article class="card">
          <span class="material-symbols-outlined" aria-hidden="true">verified</span>
          <h3>Доверие пользователей</h3>
          <p>Домен с понятным окончанием вызывает уверенность.</p>
        </article>
        <article class="card">
          <span class="material-symbols-outlined" aria-hidden="true">search</span>
          <h3>Хорошая заметность</h3>
          <p>Простой домен легче запомнить и найти.</p>
        </article>
        <article class="card">
          <span class="material-symbols-outlined" aria-hidden="true">security</span>
          <h3>Защита бренда</h3>
          <p>Закрепляет ваш проект в русскоязычной зоне.</p>
        </article>
        <article class="card">
          <span class="material-symbols-outlined" aria-hidden="true">support</span>
          <h3>Поддержка и сопровождение</h3>
          <p>Помогаем с регистрацией и подключением.</p>
        </article>
      </div>
    </section>

    <section class="wrap" id="visual" aria-labelledby="visual-title">
      <h2 class="section-title" id="visual-title">Как выглядит ваш домен</h2>
      <div class="grid">
        <div class="card">
          <h3><span data-user-domain>{{user_domain}}</span></h3>
          <p>Домен будет отображаться на всех страницах, в письмах и в ссылках на ваш сервис.</p>
        </div>
        <div class="card" aria-hidden="true" style="display:flex;align-items:center;justify-content:center">
          <div style="font-size:clamp(22px,4vw,40px);font-weight:700"><span data-user-domain>{{user_domain}}</span></div>
        </div>
      </div>
    </section>

    <section class="wrap" id="includes" aria-labelledby="includes-title">
      <h2 class="section-title" id="includes-title">Что входит в услугу</h2>
      <div class="card">
        <ul>
          <li>Регистрация домена</li>
          <li>Настройка и подключение</li>
          <li>Поддержка</li>
          <li>Привязка к профилю UpgradeFor</li>
        </ul>
      </div>
    </section>

    <section class="wrap" id="form" aria-labelledby="form-title">
      <h2 class="section-title" id="form-title">Заполните форму</h2>
      <p class="lead" id="form-status" hidden>Срок действия ссылки истёк. Отправка заявки недоступна.</p>
      <form class="card" aria-label="Форма получения домена">
        <div class="grid" style="margin-bottom:var(--space-3)">
          <div>
            <label for="first-name"><strong>Имя</strong></label>
            <input id="first-name" name="first-name" type="text" placeholder="Имя" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);margin-top:8px">
            <p class="lead" data-error-for="first-name" hidden>Пожалуйста, заполните поле</p>
          </div>
          <div>
            <label for="last-name"><strong>Фамилия</strong></label>
            <input id="last-name" name="last-name" type="text" placeholder="Фамилия" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);margin-top:8px">
            <p class="lead" data-error-for="last-name" hidden>Пожалуйста, заполните поле</p>
          </div>
        </div>
        <div class="grid" style="margin-bottom:var(--space-3)">
          <div>
            <label for="middle-name"><strong>Отчество</strong></label>
            <input id="middle-name" name="middle-name" type="text" placeholder="Отчество" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);margin-top:8px">
          </div>
          <div>
            <label for="email"><strong>Email</strong></label>
            <input id="email" name="email" type="email" placeholder="Email" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);margin-top:8px">
            <p class="lead" data-error-for="email" hidden>Пожалуйста, заполните поле</p>
          </div>
        </div>
        <button class="btn" type="submit" data-cta-button="submit">Получить мой домен</button>
        <p class="lead" id="form-message" hidden>Заявка принята. Мы свяжемся с вами в ближайшее время.</p>
      </form>
    </section>

    <section class="wrap" id="faq" aria-labelledby="faq-title">
      <h2 class="section-title" id="faq-title">FAQ</h2>
      <div style="display:grid;gap:var(--gap)">
        <details class="card">
          <summary>Как быстро происходит регистрация домена?</summary>
          <p>После подтверждения заявки домен регистрируется в стандартные сроки регистратора.</p>
        </details>
        <details class="card">
          <summary>Могу ли я сменить домен позже?</summary>
          <p>Да, в будущем можно оформить другой домен и перенастроить привязку.</p>
        </details>
        <details class="card">
          <summary>Нужно ли что-то настраивать самостоятельно?</summary>
          <p>Мы берём на себя настройку и подключение к вашему профилю.</p>
        </details>
        <details class="card">
          <summary>Что будет, если не успеть за 24 часа?</summary>
          <p>Предложение может быть пересмотрено, и домен станет доступен другим пользователям.</p>
        </details>
        <details class="card">
          <summary>Где будет использоваться домен?</summary>
          <p>В ссылках, письмах, профиле и публичных страницах вашего проекта.</p>
        </details>
        <details class="card">
          <summary>Можно ли получить помощь после регистрации?</summary>
          <p>Да, поддержка включена в услугу и отвечает на вопросы после запуска.</p>
        </details>
      </div>
    </section>

    <section class="wrap" id="final-cta" aria-labelledby="final-cta-title">
      <div class="card">
        <h2 class="section-title" id="final-cta-title">Ограничение 24 часа</h2>
        <p class="lead" id="expiry-text">Мы резервируем домен <span data-user-domain>{{user_domain}}</span> на 24 часа, чтобы вы могли принять решение без спешки. После окончания срока предложение может быть отозвано.</p>
        <a class="btn" href="#form" style="margin-top:var(--space-3)" data-cta-link="secondary">Оформить домен</a>
        <a class="btn btn--ghost" href="/signup" data-expired-link hidden style="margin-top:var(--space-2)">Запросить новую ссылку</a>
      </div>
    </section>
  </main>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var token = params.get('t');
      var currentToken = token || '';
      // TODO: fetch domain data by token from backend
      var nameParam = params.get('name');
      var domainParam = params.get('domain');
      var expiresParam = params.get('expires');
      var userName = nameParam || 'друг';
      var userDomain = domainParam || 'ваш-домен.рус';

      if (!nameParam && !domainParam && token) {
        userName = 'друг';
        userDomain = 'ваш-домен.рус';
      }

      document.querySelectorAll('[data-user-name]').forEach(function(node) {
        node.textContent = userName;
      });
      document.querySelectorAll('[data-user-domain]').forEach(function(node) {
        node.textContent = userDomain;
      });

      var countdownEl = document.getElementById('countdown');
      var expiryText = document.getElementById('expiry-text');
      var expiredLink = document.querySelector('[data-expired-link]');
      var formStatus = document.getElementById('form-status');
      var domainMissingNote = document.getElementById('domain-missing-note');
      var ctaLinks = document.querySelectorAll('[data-cta-link]');
      var ctaButton = document.querySelector('[data-cta-button]');
      var form = document.querySelector('form');
      var formMessage = document.getElementById('form-message');
      var formFields = form ? form.querySelectorAll('input') : [];
      var storageKey = 'fio-rus-expires-at';
      var expiresAt;
      var isExpired = false;

      if (expiresParam) {
        var parsedDate = new Date(expiresParam);
        if (!isNaN(parsedDate)) {
          expiresAt = parsedDate;
          localStorage.setItem(storageKey, parsedDate.toISOString());
        }
      }

      if (!expiresAt) {
        var storedExpires = localStorage.getItem(storageKey);
        if (storedExpires) {
          var storedDate = new Date(storedExpires);
          if (!isNaN(storedDate)) {
            expiresAt = storedDate;
          }
        }
      }

      if (!expiresAt) {
        var now = new Date();
        expiresAt = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        localStorage.setItem(storageKey, expiresAt.toISOString());
      }

      function disableForm() {
        if (formStatus) {
          formStatus.hidden = false;
        }
        formFields.forEach(function(field) {
          field.setAttribute('disabled', 'disabled');
        });
        if (ctaButton) {
          ctaButton.setAttribute('disabled', 'disabled');
        }
      }

      function setExpiredState() {
        isExpired = true;
        if (countdownEl) {
          countdownEl.textContent = 'Срок истёк (00:00:00)';
        }
        if (expiryText) {
          expiryText.textContent = 'Срок действия ссылки истёк. Запросите новую ссылку, чтобы продолжить.';
        }
        if (expiredLink) {
          expiredLink.hidden = false;
        }
        ctaLinks.forEach(function(link) {
          link.setAttribute('aria-disabled', 'true');
          link.setAttribute('tabindex', '-1');
        });
        disableForm();
      }

      function setDomainMissingState() {
        if (domainMissingNote) {
          domainMissingNote.hidden = false;
        }
        ctaLinks.forEach(function(link) {
          link.setAttribute('aria-disabled', 'true');
          link.setAttribute('tabindex', '-1');
        });
      }

      function formatTime(ms) {
        var totalSeconds = Math.max(0, Math.floor(ms / 1000));
        var hours = Math.floor(totalSeconds / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;
        return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
      }

      function tick() {
        var now = new Date();
        var remaining = expiresAt - now;
        if (remaining <= 0) {
          setExpiredState();
          return;
        }
        if (countdownEl) {
          countdownEl.textContent = formatTime(remaining);
        }
      }

      tick();
      var interval = setInterval(function() {
        if (new Date() > expiresAt) {
          clearInterval(interval);
          setExpiredState();
          return;
        }
        tick();
      }, 1000);

      if (userDomain === 'ваш-домен.рус') {
        setDomainMissingState();
      }

      ctaLinks.forEach(function(link) {
        link.addEventListener('click', function(event) {
          if (link.getAttribute('aria-disabled') === 'true') {
            event.preventDefault();
            return;
          }
          var firstNameField = document.getElementById('first-name');
          if (firstNameField) {
            setTimeout(function() {
              firstNameField.focus();
            }, 0);
          }
        });
      });

      function setFieldError(field, message) {
        var errorEl = document.querySelector('[data-error-for="' + field.id + '"]');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.hidden = false;
        }
        field.setAttribute('aria-invalid', 'true');
        field.style.borderColor = '#ef4444';
      }

      function clearFieldError(field) {
        var errorEl = document.querySelector('[data-error-for="' + field.id + '"]');
        if (errorEl) {
          errorEl.hidden = true;
        }
        field.removeAttribute('aria-invalid');
        field.style.borderColor = 'var(--line)';
      }

      function validateEmail(value) {
        return value.indexOf('@') > 0 && value.indexOf('.') > 0;
      }

      if (form) {
        form.addEventListener('submit', function(event) {
          event.preventDefault();
          if (isExpired) {
            disableForm();
            return;
          }

          var firstName = document.getElementById('first-name');
          var lastName = document.getElementById('last-name');
          var email = document.getElementById('email');
          var middleName = document.getElementById('middle-name');
          var isValid = true;

          [firstName, lastName, email].forEach(function(field) {
            if (!field) {
              return;
            }
            if (!field.value.trim()) {
              setFieldError(field, 'Пожалуйста, заполните поле');
              isValid = false;
            } else {
              clearFieldError(field);
            }
          });

          if (email && email.value.trim() && !validateEmail(email.value.trim())) {
            setFieldError(email, 'Пожалуйста, заполните поле');
            isValid = false;
          }

          if (!isValid) {
            return;
          }

          var payload = {
            name: firstName ? firstName.value.trim() : '',
            lastName: lastName ? lastName.value.trim() : '',
            middleName: middleName ? middleName.value.trim() : '',
            email: email ? email.value.trim() : '',
            domain: userDomain,
            token: currentToken,
            expiresAt: expiresAt ? expiresAt.toISOString() : ''
          };

          // TODO: send to backend /api/domain-request
          console.log('Domain request payload:', payload);

          if (formMessage) {
            formMessage.hidden = false;
          }
        });
      }
    })();
  </script>
  <script src="/assets/load-layout.js"></script>
</body>
</html>
